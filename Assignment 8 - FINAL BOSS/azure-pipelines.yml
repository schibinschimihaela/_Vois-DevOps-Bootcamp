trigger:
- none

variables:
- group: aws-cred-mihaela

parameters:
- name: terraformApply
  displayName: "Run Terraform Apply (create infrastructure)"
  type: boolean
  default: false

pool:
  vmImage: ubuntu-latest

stages:

# STAGE 1 – TERRAFORM VALIDATE (ALWAYS)
- stage: Terraform_Validate
  displayName: Terraform Validate
  jobs:
  - job: TerraformValidate
    displayName: Terraform Init & Validate
    steps:
    - checkout: self

    - script: |
        curl -fsSL https://releases.hashicorp.com/terraform/1.6.6/terraform_1.6.6_linux_amd64.zip -o terraform.zip
        unzip terraform.zip
        sudo mv terraform /usr/local/bin/
        terraform version
      displayName: Install Terraform CLI

    - script: |
        cd terraform
        terraform init -backend=false
        terraform validate
      displayName: Terraform Init & Validate
      env:
        AWS_REGION: $(AWS_REGION)

# STAGE 2 – TERRAFORM APPLY (OPTIONAL, MANUAL)
- stage: Terraform_Apply
  displayName: Terraform Apply (Create Infrastructure)
  dependsOn: Terraform_Validate
  condition: eq('${{ parameters.terraformApply }}', true)
  jobs:
  - job: TerraformApply
    displayName: Terraform Apply
    steps:
    - checkout: self

    - script: |
        curl -fsSL https://releases.hashicorp.com/terraform/1.6.6/terraform_1.6.6_linux_amd64.zip -o terraform.zip
        unzip terraform.zip
        sudo mv terraform /usr/local/bin/
        terraform version
      displayName: Install Terraform CLI

    - script: |
        cd terraform
        terraform init
        terraform apply -auto-approve
      displayName: Terraform Apply
      env:
        AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
        AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
        AWS_REGION: $(AWS_REGION)

# STAGE 3 – BUILD & PUSH DOCKER IMAGE
- stage: Build_Test
  displayName: Build & Push Docker Image
  dependsOn: Terraform_Apply
  condition: always()
  jobs:
  - job: BuildAndPush
    displayName: Build & Push to ECR
    steps:
    - checkout: self

    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.11'
      displayName: Set up Python 3.11

    - script: |
        aws ecr get-login-password --region $(AWS_REGION) \
          | docker login \
            --username AWS \
            --password-stdin $(AWS_ACCOUNT_ID).dkr.ecr.$(AWS_REGION).amazonaws.com
      displayName: Login to ECR
      env:
        AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
        AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)

    - script: |
        docker build -t ip-spectre -f docker/Dockerfile .
        docker tag ip-spectre:latest \
          $(AWS_ACCOUNT_ID).dkr.ecr.$(AWS_REGION).amazonaws.com/ip-spectre:latest
        docker push \
          $(AWS_ACCOUNT_ID).dkr.ecr.$(AWS_REGION).amazonaws.com/ip-spectre:latest
      displayName: Build & Push Docker Image
      env:
        AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
        AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
        AWS_REGION: $(AWS_REGION)
