trigger:
- none

variables:
- group: aws-cred-mihaela
- name: PROJECT_ROOT
  value: "Assignment 8 - FINAL BOSS"

parameters:
- name: terraformApply
  displayName: "Run Terraform Apply (create infrastructure)"
  type: boolean
  default: false

- name: terraformDestroy
  displayName: "Run Terraform Destroy (delete infrastructure)"
  type: boolean
  default: false

pool:
  vmImage: ubuntu-latest

jobs:

- job: Infrastructure
  displayName: Infrastructure Management
  steps:
  - checkout: self

  - bash: |
      echo "Installing Terraform..."
      curl -fsSL https://releases.hashicorp.com/terraform/1.6.6/terraform_1.6.6_linux_amd64.zip -o terraform.zip
      unzip -q terraform.zip
      sudo mv terraform /usr/local/bin/
      rm terraform.zip
      terraform version
    displayName: Install Terraform CLI

  - bash: |
      terraform init
    displayName: Terraform Init
    workingDirectory: "$(PROJECT_ROOT)/terraform"
    env:
      AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
      AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
      AWS_REGION: $(AWS_REGION)

  - bash: |
      terraform validate
    displayName: Terraform Validate
    workingDirectory: "$(PROJECT_ROOT)/terraform"

  - bash: |
      terraform apply -auto-approve
    displayName: Terraform Apply
    workingDirectory: "$(PROJECT_ROOT)/terraform"
    condition: eq('${{ parameters.terraformApply }}', true)
    env:
      AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
      AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
      AWS_REGION: $(AWS_REGION)

  - bash: |
      terraform destroy -auto-approve
    displayName: Terraform Destroy
    workingDirectory: "$(PROJECT_ROOT)/terraform"
    condition: eq('${{ parameters.terraformDestroy }}', true)
    env:
      AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
      AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
      AWS_REGION: $(AWS_REGION)

- job: Docker
  displayName: Build & Push Docker Image
  dependsOn: Infrastructure
  condition: and(succeeded(), eq('${{ parameters.terraformApply }}', true))
  steps:
  - checkout: self

  - task: UsePythonVersion@0
    inputs:
      versionSpec: '3.11'
    displayName: Set up Python 3.11

  - bash: |
      aws ecr get-login-password --region $(AWS_REGION) \
        | docker login \
          --username AWS \
          --password-stdin $(AWS_ACCOUNT_ID).dkr.ecr.$(AWS_REGION).amazonaws.com
    displayName: Login to Amazon ECR
    env:
      AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
      AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
      AWS_REGION: $(AWS_REGION)

  - bash: |
      docker build -t ip-spectre -f docker/Dockerfile .
      docker tag ip-spectre:latest \
        $(AWS_ACCOUNT_ID).dkr.ecr.$(AWS_REGION).amazonaws.com/ip-spectre:latest
      docker push \
        $(AWS_ACCOUNT_ID).dkr.ecr.$(AWS_REGION).amazonaws.com/ip-spectre:latest
    displayName: Build & Push Docker Image to ECR
    workingDirectory: "$(PROJECT_ROOT)"
    env:
      AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
      AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
      AWS_REGION: $(AWS_REGION)